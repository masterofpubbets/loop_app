
IF OBJECT_ID('tempdb..#BoxupTasks') IS NOT NULL
    BEGIN
        DROP TABLE #BoxupTasks
    END
CREATE TABLE  #BoxupTasks (
    FolderName NVARCHAR(250) NOT NULL,
    ElementTag NVARCHAR(250) NOT NULL,
    Source NVARCHAR(100) NULL
)

IF OBJECT_ID('tempdb..#Tasks') IS NOT NULL
    BEGIN
        DROP TABLE #Tasks
    END
CREATE TABLE  #Tasks (
    FolderName NVARCHAR(250) NOT NULL,
    ElementTag NVARCHAR(250) NOT NULL,
    FormName NVARCHAR(250) NOT NULL,
    ClosedDate NVARCHAR(50) NULL
)

IF OBJECT_ID('tempdb..#BoxupSQMSTasks') IS NOT NULL
    BEGIN
        DROP TABLE #BoxupSQMSTasks
    END
CREATE TABLE  #BoxupSQMSTasks (
    FolderName NVARCHAR(250) NOT NULL,
    ElementTag NVARCHAR(250) NOT NULL,
    FormName NVARCHAR(250) NULL,
    ClosingDate NVARCHAR(50) NULL
)

TRUNCATE TABLE HCS.BoxupSQMSTasksS

INSERT INTO #BoxupTasks
SELECT DISTINCT
    tblBoxup.FolderName,
    [HCS].[ProjectElements].[ElementTag],
    HCS.ProjectElements.ImportSource
FROM [HCS].[ProjectElements]
INNER JOIN tblBoxup ON [HCS].[ProjectElements].[Group] = tblBoxup.FolderName

INSERT INTO #Tasks
SELECT
    [Group], ElementTag, FormName, ClosingDate
FROM HCS.SQMSTasks
--WHERE (NodeLevel <> 'Gr' AND Phase = 'Construction' AND FormName NOT IN ('10160-CON-INS-26', '10160-CON-INS-26_Double','10160-CON-INS-11', '10160-CON-ROT-10', '10160-PACKAGE-INS-01', '10160-PACKAGE-ELE-01', '10160-CON-PIP-02'))
--OR (FormName IN ('10160-CON-ELE-28', '10160-CON-ELE-29'))
XXFilterXX


INSERT INTO #BoxupSQMSTasks
SELECT DISTINCT
#BoxupTasks.FolderName,
#Tasks.ElementTag, #Tasks.FormName, #Tasks.ClosedDate
FROM #BoxupTasks
INNER JOIN #Tasks ON #BoxupTasks.ElementTag = #Tasks.ElementTag COLLATE Modern_Spanish_CI_AS


INSERT INTO HCS.BoxupSQMSTasksS
SELECT
    FolderName,
    COUNT(ElementTag) AS [Task Count],
    COUNT(ClosingDate) AS [Task Closed]
    FROM #BoxupSQMSTasks
    GROUP BY FolderName

UPDATE V
    SET V.TR_Loop_Folder_QC_Release = GETDATE()
FROM (
    SELECT
    tblBoxup.FolderName, TR_Loop_Folder_QC_Release
    FROM tblBoxup
    INNER JOIN (
        SELECT
        FolderName,
        TaskCount AS [Task Count],
        TaskClosed AS [Task Closed]
        FROM HCS.BoxupSQMSTasksS
        WHERE TaskCount = TaskClosed
    ) AS LQCReleased
    ON tblBoxup.FolderName = LQCReleased.FolderName COLLATE SQL_Latin1_General_CP1_CI_AS
    WHERE tblBoxup.TR_Loop_Folder_QC_Release IS NULL
) AS V

DROP TABLE #BoxupTasks
DROP TABLE #Tasks
DROP TABLE #BoxupSQMSTasks